<!-- partials/tracking/construction-tracking.ejs -->
<%
// Tracking configuration for construction security services
const serviceData = (typeof locals !== 'undefined' && locals.serviceData) ? locals.serviceData : {};
const {
    serviceType = 'construction_security',
    priceRange = { low: 45, mid: 65, high: 85 }
} = serviceData;
%>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-SHIELD2025');</script>

<!-- Enhanced Google Analytics 4 with Construction Security Tracking -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SHLD9876543"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Enhanced Consent Mode v2 for 2025 compliance
gtag('consent', 'default', {
    'analytics_storage': 'denied',
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'functionality_storage': 'granted',
    'security_storage': 'granted'
});

gtag('js', new Date());
gtag('config', 'G-SHLD9876543', {
    'anonymize_ip': true,
    'allow_google_signals': false,
    'allow_ad_personalization_signals': false,
    'cookie_flags': 'SameSite=None;Secure',
    'custom_map': {
        'custom_parameter_1': 'service_type',
        'custom_parameter_2': 'construction_phase',
        'custom_parameter_3': 'location_served',
        'custom_parameter_4': 'project_type'
    },
    'user_properties': {
        'service_interest': '<%= serviceType %>',
        'visitor_type': 'construction_security_prospect',
        'industry_focus': 'construction'
    }
});

// Construction Security specific page view tracking
gtag('event', 'page_view', {
    'service_type': '<%= serviceType %>',
    'price_range': '<%= priceRange.low %>-<%= priceRange.high %>',
    'location': 'California',
    'page_category': 'construction_security_page',
    'content_group1': 'Construction Security Services',
    'content_group2': 'Site Protection Services',
    'construction_phase': 'all_phases',
    'project_type': 'all_construction_types'
});

// Construction Security service view tracking
gtag('event', 'view_item', {
    'currency': 'USD',
    'value': <%= priceRange.low %>,
    'items': [{
        'item_id': '<%= serviceType %>_construction_security_service',
        'item_name': 'Construction Site Security Service',
        'item_category': 'Construction Security Services',
        'item_brand': 'ShieldWise Security',
        'price': <%= priceRange.low %>,
        'quantity': 1,
        'item_variant': 'professional_guards'
    }]
});
</script>

<!-- Microsoft Clarity with Construction Security Configuration -->
<script type="text/javascript">
(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "construction_clarity_id");

// Enhanced Clarity tracking for construction security
clarity('set', 'service_type', '<%= serviceType %>');
clarity('set', 'page_type', 'construction_security');
clarity('set', 'price_range', '<%= priceRange.low %>-<%= priceRange.high %>');
clarity('set', 'industry_focus', 'construction_sites');
clarity('set', 'geographic_focus', 'california_statewide');
</script>

<!-- Facebook Pixel with Construction Security Enhanced Conversions -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '987654321098765', {
    'external_id': 'construction_security_visitor'
});
fbq('track', 'PageView');

// Enhanced Facebook tracking for construction security services
fbq('track', 'ViewContent', {
    content_type: 'construction_security_service',
    content_name: '<%= serviceType %>_construction_security_service',
    content_category: 'Construction Security Services',
    value: <%= priceRange.low %>,
    currency: 'USD',
    contents: [{
        'id': '<%= serviceType %>_construction_security',
        'quantity': 1,
        'item_price': <%= priceRange.low %>,
        'category': 'construction_site_protection'
    }],
    custom_data: {
        'security_level': 'construction',
        'site_coverage': '24_7_protection',
        'service_area': 'california',
        'industry_type': 'construction'
    }
});
</script>

<!-- LinkedIn Insight Tag with Enhanced B2B Construction Security Tracking -->
<script type="text/javascript">
_linkedin_partner_id = "5432109";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);

// Enhanced LinkedIn tracking for construction security
window._linkedin_custom_data = {
    'service_type': '<%= serviceType %>',
    'industry': 'construction_security_services',
    'price_range': '<%= priceRange.low %>-<%= priceRange.high %>',
    'target_audience': 'construction_managers_contractors',
    'geographic_focus': 'california',
    'service_specialization': 'construction_site_protection'
};
</script>
<script type="text/javascript">
(function(l) {
    if (!l){window.lintrk = function(a,b){window.lintrk.q.push([a,b])};
    window.lintrk.q=[]}
    var s = document.getElementsByTagName("script")[0];
    var b = document.createElement("script");
    b.type = "text/javascript";b.async = true;
    b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
    s.parentNode.insertBefore(b, s);})(window.lintrk);
</script>

<!-- Hotjar Tracking with Construction Security User Attributes -->
<script>
(function(h,o,t,j,a,r){
    h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
    h._hjSettings={hjid:3789456,hjsv:6};
    a=o.getElementsByTagName('head')[0];
    r=o.createElement('script');r.async=1;
    r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
    a.appendChild(r);
})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');

// Set user attributes for Hotjar - Construction Security specific
hj('identify', 'construction_security_visitor', {
    'service_interest': '<%= serviceType %>',
    'page_type': 'construction_security',
    'price_range': '<%= priceRange.low %>-<%= priceRange.high %>',
    'industry_focus': 'construction_sites',
    'geographic_market': 'california'
});
</script>

<!-- CallRail Phone Tracking for Construction Security -->
<script>
var _cr = _cr || [];
_cr.push(['setAccount', 'CONSTRUCTION_CALLRAIL_ID']);
_cr.push(['setDefaultNumber', '+17147167430']);
(function() {
    var s = document.createElement('script');
    s.src = 'https://d2bd1vs2mojgbu.cloudfront.net/1.0.0/cr.js';
    s.async = true;
    var c = document.getElementsByTagName('script')[0];
    c.parentNode.insertBefore(s, c);
})();
</script>

<!-- Custom Construction Security Event Tracking Functions -->
<script>
// Enhanced lead tracking functions for construction security
function trackConstructionConsultationRequest() {
    // Google Analytics 4
    gtag('event', 'generate_lead', {
        'event_category': 'Construction Security Services',
        'event_label': '<%= serviceType %>',
        'value': 1,
        'currency': 'USD',
        'service_type': '<%= serviceType %>',
        'lead_source': 'construction_consultation_request',
        'industry_type': 'construction',
        'project_phase': 'planning'
    });
    
    // Facebook Pixel
    fbq('track', 'Lead', {
        content_name: '<%= serviceType %> Construction Security Consultation',
        content_category: 'Construction Security Services',
        value: <%= priceRange.low %>,
        currency: 'USD',
        custom_data: {
            'security_type': 'construction',
            'consultation_type': 'site_assessment'
        }
    });
    
    // LinkedIn
    lintrk('track', { conversion_id: 12346 });
    
    // Microsoft Clarity
    clarity('event', 'construction_consultation_request');
    
    // Hotjar
    hj('event', 'construction_consultation_request');
}

// Construction project type interest tracking
function trackProjectTypeInterest(projectType) {
    gtag('event', 'project_type_interest', {
        'event_category': 'Construction Security Project Types',
        'event_label': projectType,
        'service_type': '<%= serviceType %>',
        'project_type': projectType.toLowerCase().replace(/\s+/g, '_')
    });
    
    clarity('event', 'project_type_interest', {
        'project_type': projectType
    });
}

// Fire watch service interest tracking
function trackFireWatchInterest() {
    gtag('event', 'fire_watch_interest', {
        'event_category': 'Construction Security Specialized Services',
        'event_label': 'Fire Watch Services',
        'service_type': '<%= serviceType %>',
        'specialized_service': 'fire_watch'
    });
    
    fbq('track', 'ViewContent', {
        content_name: 'Fire Watch Services',
        content_category: 'Specialized Construction Security',
        value: <%= priceRange.mid %>,
        currency: 'USD'
    });
    
    clarity('event', 'fire_watch_service_interest');
}

// Equipment protection interest tracking
function trackEquipmentProtectionInterest() {
    gtag('event', 'equipment_protection_interest', {
        'event_category': 'Construction Security Equipment Protection',
        'event_label': 'Equipment Theft Prevention',
        'service_type': '<%= serviceType %>',
        'protection_type': 'equipment_security'
    });
    
    clarity('event', 'equipment_protection_interest');
}

// Construction phase specific tracking
function trackConstructionPhaseInterest(phase) {
    gtag('event', 'construction_phase_interest', {
        'event_category': 'Construction Security Phases',
        'event_label': phase,
        'service_type': '<%= serviceType %>',
        'construction_phase': phase.toLowerCase().replace(/\s+/g, '_')
    });
    
    clarity('event', 'construction_phase_interest', {
        'construction_phase': phase
    });
}

// Site assessment request tracking
function trackSiteAssessmentRequest() {
    gtag('event', 'site_assessment_request', {
        'event_category': 'Construction Security Assessment',
        'event_label': 'Free Site Assessment',
        'service_type': '<%= serviceType %>',
        'value': <%= priceRange.mid %>,
        'assessment_type': 'comprehensive_site_evaluation'
    });
    
    fbq('track', 'Schedule', {
        content_name: 'Construction Site Security Assessment',
        content_category: 'Security Assessments',
        value: <%= priceRange.mid %>,
        currency: 'USD'
    });
    
    clarity('event', 'site_assessment_request');
    hj('event', 'site_assessment_request');
}

// Enhanced form tracking for construction security
function trackConstructionSecurityFormSubmission(formType) {
    gtag('event', 'form_submit', {
        'event_category': 'Construction Security Lead Generation',
        'event_label': formType,
        'service_type': '<%= serviceType %>',
        'value': 1,
        'form_type': formType,
        'industry_focus': 'construction'
    });
    
    fbq('track', 'CompleteRegistration', {
        content_name: formType + ' Construction Security Form',
        content_category: 'Construction Security Forms',
        value: <%= priceRange.low %>,
        currency: 'USD',
        custom_data: {
            'security_type': 'construction',
            'form_category': formType
        }
    });
    
    clarity('event', 'construction_security_form_submission', {
        'form_type': formType,
        'industry_focus': 'construction'
    });
    
    hj('event', 'construction_security_form_submission');
}

// Emergency response interest tracking
function trackEmergencyResponseInterest() {
    gtag('event', 'emergency_response_interest', {
        'event_category': 'Construction Security Emergency Services',
        'event_label': 'Emergency Response Capability',
        'service_type': '<%= serviceType %>',
        'response_type': 'emergency_dispatch'
    });
    
    clarity('event', 'emergency_response_interest');
}

// Mobile patrol interest tracking
function trackMobilePatrolInterest() {
    gtag('event', 'mobile_patrol_interest', {
        'event_category': 'Construction Security Mobile Services',
        'event_label': 'Mobile Patrol Services',
        'service_type': '<%= serviceType %>',
        'patrol_type': 'mobile_security'
    });
    
    clarity('event', 'mobile_patrol_interest');
}

// CCTV monitoring interest tracking
function trackCCTVMonitoringInterest() {
    gtag('event', 'cctv_monitoring_interest', {
        'event_category': 'Construction Security Technology',
        'event_label': 'CCTV Surveillance',
        'service_type': '<%= serviceType %>',
        'technology_type': 'video_surveillance'
    });
    
    clarity('event', 'cctv_monitoring_interest');
}

// Phone call tracking with construction context
function trackPhoneClick() {
    gtag('event', 'phone_call', {
        'event_category': 'Contact',
        'event_label': 'Construction Security Phone',
        'value': 1,
        'service_type': '<%= serviceType %>',
        'contact_method': 'phone',
        'industry_context': 'construction'
    });
    
    fbq('track', 'Contact', {
        content_name: 'Construction Security Phone Call',
        content_category': 'Contact'
    });
    
    clarity('event', 'construction_security_phone_click');
}

// Quote request tracking
function trackQuoteRequest() {
    gtag('event', 'quote_request', {
        'event_category': 'Construction Security Quote',
        'event_label': 'Free Quote Request',
        'service_type': '<%= serviceType %>',
        'value': <%= priceRange.mid %>,
        'quote_type': 'construction_security'
    });
    
    fbq('track', 'InitiateCheckout', {
        content_name: 'Construction Security Quote',
        content_category: 'Security Services',
        value: <%= priceRange.mid %>,
        currency: 'USD'
    });
    
    clarity('event', 'construction_quote_request');
    hj('event', 'construction_quote_request');
}
</script>