# Solution: EJS Template Error Fix

## Option 1: Create a separate helpers file

1. Create a new file `views/Partials/meta-helpers.ejs`:

```ejs
<%
/**
 * Helper functions for meta tags
 */

// Helper function: truncateTitle
// Ensures <title> never exceeds about 58 characters (minus the suffix).
function truncateTitle(title, maxLength = 58) {
  if (!title) return 'Security Services | ShieldWise';
  const suffix = ' | ShieldWise';
  const maxTitleLength = maxLength - suffix.length;
  if (title.length > maxTitleLength) {
    return title.substring(0, maxTitleLength).trim() + '...' + suffix;
  } else {
    return title + suffix;
  }
}

// Helper function: truncateDescription
// Ensures <meta name="description"> never exceeds about 155 characters.
function truncateDescription(desc, maxLength = 155) {
  if (!desc) {
    return 'Professional security services in California. BSIS licensed guards, 24/7 monitoring. Call 1-800-SHIELD-1 for free assessment.';
  }
  if (desc.length > maxLength) {
    return desc.substring(0, maxLength).trim() + '...';
  }
  return desc;
}

// Helper function: generateDynamicKeywords
// Combines baseKeywords + serviceType phrases + "California security company" snippet.
function generateDynamicKeywords(baseKeywords, serviceType, location = 'California') {
  const base = baseKeywords || '';
  const dynamic = `${serviceType} security, ${location} security company, licensed security guards, 24/7 security services`;
  return base + (base ? ', ' : '') + dynamic;
}
%>
```

2. Modify `meta-tags-base.ejs` to include this helper file:

```ejs
<%- include('meta-helpers') %>
<%
  // First, pull in any "serviceData" that was passed down from the route:
  //   res.render('services/apartment-security', { serviceData });
  //
  // If "serviceData" is missing or some fields are undefined, we fall back to defaults.
  //

  // Destructure serviceData if it exists; otherwise use empty object
  const {
    serviceTitle,
    serviceDescription,
    serviceKeywords,
    serviceImage,
    serviceUrl,
    serviceType,
    serviceBenefit,
    propertyType,
    priceRange,
    serviceAltName,
    serviceOutput,
    audienceType
  } = typeof locals.serviceData !== 'undefined' ? serviceData : {};

  // Now build a "safeServiceData" object, filling in defaults if any property is missing:
  const safeServiceData = {
    serviceTitle:       serviceTitle       || 'Professional Security Services',
    serviceDescription: serviceDescription || 'Professional security services with licensed guards and 24/7 monitoring.',
    serviceKeywords:    serviceKeywords    || 'security services, security guards',
    serviceImage:       serviceImage       || 'default-security-service.webp',
    serviceUrl:         serviceUrl         || 'security-services',
    serviceType:        serviceType        || 'security',
    serviceBenefit:     serviceBenefit     || 'enhanced protection and peace of mind',
    propertyType:       propertyType       || 'property',
    priceRange:         priceRange         || { low: 35, mid: 55, high: 85 },
    serviceAltName:     serviceAltName     || 'Security Guard Services',
    serviceOutput:      serviceOutput      || 'Enhanced security and protection',
    audienceType:       audienceType       || 'Property Managers and Business Owners'
  };
%>
```

3. Modify `meta-tags-service.ejs` to also include the helper file:

```ejs
<%- include('meta-helpers') %>
<%- include('meta-tags-base') %>
<%
  // meta-tags-service.ejs
  // After including meta-tags-base.ejs (which defines our helper functions
  // and safeServiceData), we now generate the optimized <title>, <meta>, and OG/Twitter tags.
  
  // Build optimized Title, Description, and Keywords using our helper functions:
  const optimizedTitle = truncateTitle(
    `${safeServiceData.serviceTitle} | 24/7 Guards from $${safeServiceData.priceRange.low}/hr`
  );

  const optimizedDescription = truncateDescription(
    `${safeServiceData.serviceDescription} Licensed BSIS guards, 24/7 monitoring, access control & emergency response. 4.9★ (287+ reviews). Call 1-800-SHIELD-1.`
  );

  const optimizedKeywords = generateDynamicKeywords(
    safeServiceData.serviceKeywords,
    safeServiceData.serviceType
  );
%>
```

## Option 2: Restructure the templates to avoid nested includes

An alternative approach is to restructure your template includes to avoid the nested includes pattern:

1. In `apartment-security.ejs`, include both files directly:

```ejs
<html lang="en">
<head>
    <%- include('../Partials/meta-tags-base', serviceData) %>
    <%- include('../Partials/meta-tags-service', serviceData) %>
    <%- include('../Partials/performance-optimization') %>
    <%- include('../Partials/mobile-app-meta') %>
    <!-- rest of your head content -->
</head>
<body>
    <!-- body content -->
</body>
</html>
```

2. Then modify `meta-tags-service.ejs` to remove the include for `meta-tags-base.ejs`:

```ejs
<%
  // meta-tags-service.ejs
  // Uses helper functions and safeServiceData from meta-tags-base
  
  // Build optimized Title, Description, and Keywords using our helper functions:
  const optimizedTitle = truncateTitle(
    `${safeServiceData.serviceTitle} | 24/7 Guards from $${safeServiceData.priceRange.low}/hr`
  );

  const optimizedDescription = truncateDescription(
    `${safeServiceData.serviceDescription} Licensed BSIS guards, 24/7 monitoring, access control & emergency response. 4.9★ (287+ reviews). Call 1-800-SHIELD-1.`
  );

  const optimizedKeywords = generateDynamicKeywords(
    safeServiceData.serviceKeywords,
    safeServiceData.serviceType
  );
%>

<!-- Core SEO Meta Tags -->
<meta charset="UTF-8">
<!-- Rest of your meta tags -->
```

## Recommended Approach

Option 1 is more maintainable as it:
1. Separates concerns (helper functions in one file)
2. Makes code reusable across multiple templates
3. Prevents duplication of code

This approach follows the DRY (Don't Repeat Yourself) principle and will make your code easier to maintain in the long run.