<%
// tracking-scripts-armed-security.ejs
// Enhanced tracking specifically for armed security services

const serviceData = (typeof locals !== 'undefined' && locals.serviceData) ? locals.serviceData : {};
const {
    serviceType = 'armed_security',
    priceRange = { low: 75, mid: 95, high: 125 }
} = serviceData;
%>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-SHIELD2025');</script>

<!-- Enhanced Google Analytics 4 with Armed Security Tracking -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SHLD9876543"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Enhanced Consent Mode v2 for 2025 compliance
gtag('consent', 'default', {
    'analytics_storage': 'denied',
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'functionality_storage': 'granted',
    'security_storage': 'granted'
});

gtag('js', new Date());
gtag('config', 'G-SHLD9876543', {
    'anonymize_ip': true,
    'allow_google_signals': false,
    'allow_ad_personalization_signals': false,
    'cookie_flags': 'SameSite=None;Secure',
    'custom_map': {
        'custom_parameter_1': 'service_type',
        'custom_parameter_2': 'price_range',
        'custom_parameter_3': 'armed_security_level',
        'custom_parameter_4': 'response_time_required'
    },
    'user_properties': {
        'service_interest': '<%= serviceType %>',
        'visitor_type': 'armed_security_prospect',
        'security_level': 'high_risk'
    }
});

// Armed Security specific page view tracking
gtag('event', 'page_view', {
    'service_type': '<%= serviceType %>',
    'price_range': '<%= priceRange.low %>-<%= priceRange.high %>',
    'location': 'California',
    'page_category': 'armed_security_page',
    'content_group1': 'Armed Security Services',
    'content_group2': '<%= serviceType.charAt(0).toUpperCase() + serviceType.slice(1) %> Security',
    'armed_security_level': 'premium',
    'response_time_required': '15_minutes'
});

// Armed Security service view tracking
gtag('event', 'view_item', {
    'currency': 'USD',
    'value': <%= priceRange.low %>,
    'items': [{
        'item_id': '<%= serviceType %>_armed_security_service',
        'item_name': 'Armed Security Guard Service',
        'item_category': 'Armed Security Services',
        'item_brand': 'ShieldWise Security',
        'price': <%= priceRange.low %>,
        'quantity': 1,
        'item_variant': 'armed_protection'
    }]
});
</script>

<!-- Microsoft Clarity with Armed Security Configuration -->
<script type="text/javascript">
(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "armed_sec_clarity");

// Enhanced Clarity tracking for armed security
clarity('set', 'service_type', '<%= serviceType %>');
clarity('set', 'page_type', 'armed_security');
clarity('set', 'price_range', '<%= priceRange.low %>-<%= priceRange.high %>');
clarity('set', 'security_level', 'armed_protection');
clarity('set', 'response_guarantee', '15_minutes');
</script>

<!-- Facebook Pixel with Armed Security Enhanced Conversions -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '987654321098765', {
    'external_id': 'armed_security_visitor'
});
fbq('track', 'PageView');

// Enhanced Facebook tracking for armed security services
fbq('track', 'ViewContent', {
    content_type: 'armed_security_service',
    content_name: '<%= serviceType %>_armed_security_service',
    content_category: 'Armed Security Services',
    value: <%= priceRange.low %>,
    currency: 'USD',
    contents: [{
        'id': '<%= serviceType %>_armed_security',
        'quantity': 1,
        'item_price': <%= priceRange.low %>,
        'category': 'armed_protection'
    }],
    custom_data: {
        'security_level': 'armed',
        'response_time': '15_minutes',
        'service_area': 'california'
    }
});
</script>

<!-- LinkedIn Insight Tag with Enhanced B2B Armed Security Tracking -->
<script type="text/javascript">
_linkedin_partner_id = "5432109";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);

// Enhanced LinkedIn tracking for armed security
window._linkedin_custom_data = {
    'service_type': '<%= serviceType %>',
    'industry': 'armed_security_services',
    'price_range': '<%= priceRange.low %>-<%= priceRange.high %>',
    'security_level': 'armed_protection',
    'target_audience': 'high_risk_businesses'
};
</script>
<script type="text/javascript">
(function(l) {
if (!l){window.lintrk = function(a,b){window.lintrk.q.push([a,b])};
window.lintrk.q=[]}
var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})(window.lintrk);
</script>

<!-- Hotjar Tracking with Armed Security User Attributes -->
<script>
(function(h,o,t,j,a,r){
    h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
    h._hjSettings={hjid:3789456,hjsv:6};
    a=o.getElementsByTagName('head')[0];
    r=o.createElement('script');r.async=1;
    r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
    a.appendChild(r);
})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');

// Set user attributes for Hotjar - Armed Security specific
hj('identify', 'armed_security_visitor', {
    'service_interest': '<%= serviceType %>',
    'page_type': 'armed_security',
    'price_range': '<%= priceRange.low %>-<%= priceRange.high %>',
    'security_level': 'armed_protection',
    'urgency_level': 'high'
});
</script>

<!-- Custom Armed Security Event Tracking -->
<script>
// Enhanced lead tracking functions for armed security
function trackArmedSecurityConsultation() {
    // Google Analytics 4
    gtag('event', 'generate_lead', {
        'event_category': 'Armed Security Services',
        'event_label': '<%= serviceType %>',
        'value': 1,
        'currency': 'USD',
        'service_type': '<%= serviceType %>',
        'lead_source': 'armed_consultation_request',
        'security_level': 'armed',
        'urgency': 'high'
    });

    // Facebook Pixel
    fbq('track', 'Lead', {
        content_name: '<%= serviceType %> Armed Security Consultation',
        content_category: 'Armed Security Services',
        value: <%= priceRange.low %>,
        currency: 'USD',
        custom_data: {
            'security_type': 'armed',
            'response_time': '15_minutes'
        }
    });

    // LinkedIn
    lintrk('track', { conversion_id: 12345 });

    // Microsoft Clarity
    clarity('event', 'armed_consultation_request');

    // Hotjar
    hj('event', 'armed_consultation_request');
}

// Enhanced phone tracking for armed security
function trackArmedSecurityPhoneCall() {
    gtag('event', 'phone_call', {
        'event_category': 'Armed Security Contact',
        'event_label': 'Emergency Hotline',
        'value': 1,
        'service_type': '<%= serviceType %>',
        'call_type': 'armed_security_emergency'
    });

    fbq('track', 'Contact', {
        content_name: 'Armed Security Phone Call',
        content_category': 'Emergency Contact',
        custom_data: {
            'security_level': 'armed',
            'contact_type': 'emergency'
        }
    });

    clarity('event', 'armed_security_phone_click');
}

// Emergency request tracking
function trackEmergencyArmedRequest() {
    gtag('event', 'emergency_request', {
        'event_category': 'Armed Security Emergency',
        'event_label': 'Immediate Response',
        'service_type': '<%= serviceType %>',
        'value': <%= priceRange.high %>,
        'urgency': 'emergency',
        'response_time_needed': 'immediate'
    });

    fbq('track', 'Schedule', {
        content_name: 'Emergency Armed Security',
        content_category: 'Emergency Services',
        value: <%= priceRange.high %>,
        currency: 'USD'
    });

    clarity('event', 'emergency_armed_request');
    hj('event', 'emergency_armed_request');
}

// Enhanced form tracking for armed security
function trackArmedSecurityFormSubmission(formType) {
    gtag('event', 'form_submit', {
        'event_category': 'Armed Security Lead Generation',
        'event_label': formType,
        'service_type': '<%= serviceType %>',
        'value': 1,
        'form_type': formType,
        'security_level': 'armed'
    });

    fbq('track', 'CompleteRegistration', {
        content_name: formType + ' Armed Security Form',
        content_category: 'Armed Security Forms',
        value: <%= priceRange.low %>,
        currency: 'USD',
        custom_data: {
            'security_type': 'armed',
            'form_category': formType
        }
    });

    clarity('event', 'armed_security_form_submission', {
        'form_type': formType,
        'security_level': 'armed'
    });

    hj('event', 'armed_security_form_submission');
}

// Quote request tracking specifically for armed security
function trackArmedSecurityQuoteRequest() {
    gtag('event', 'begin_checkout', {
        'event_category': 'Armed Security Quote',
        'currency': 'USD',
        'value': <%= priceRange.mid %>,
        'items': [{
            'item_id': 'armed_security_quote',
            'item_name': 'Armed Security Quote Request',
            'item_category': 'Armed Security Services',
            'price': <%= priceRange.mid %>,
            'quantity': 1
        }]
    });

    fbq('track', 'InitiateCheckout', {
        content_name: 'Armed Security Quote',
        content_category: 'Security Services',
        value: <%= priceRange.mid %>,
        currency: 'USD',
        num_items: 1
    });
}

// Page engagement tracking for armed security
document.addEventListener('DOMContentLoaded', function() {
    // Track CTA button clicks
    document.querySelectorAll('.btn-custom, .cta-button, [data-track="armed-button"]').forEach(function(button) {
        button.addEventListener('click', function() {
            let buttonText = this.textContent.trim() || this.getAttribute('aria-label') || 'Armed Security CTA';
            gtag('event', 'click', {
                'event_category': 'Armed Security Button',
                'event_label': buttonText,
                'service_type': '<%= serviceType %>',
                'security_level': 'armed'
            });

            clarity('event', 'armed_security_button_click', {
                'button_text': buttonText
            });
        });
    });

    // Track response guarantee clicks
    document.querySelectorAll('.response-guarantee').forEach(function(element) {
        element.addEventListener('click', function() {
            gtag('event', 'click', {
                'event_category': 'Armed Security Feature',
                'event_label': 'Response Guarantee',
                'service_type': '<%= serviceType %>'
            });
        });
    });

    // Track testimonial interactions
    document.querySelectorAll('.testimonial-card').forEach(function(card) {
        card.addEventListener('click', function() {
            gtag('event', 'engagement', {
                'event_category': 'Armed Security Testimonial',
                'event_label': 'Testimonial Click',
                'service_type': '<%= serviceType %>'
            });
        });
    });
});

// Scroll depth tracking enhanced for armed security
let armedSecurityScrollDepths = [25, 50, 75, 90];
let armedScrollDepthTracked = [];

window.addEventListener('scroll', function() {
    let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    let docHeight = document.documentElement.scrollHeight - window.innerHeight;
    let scrollPercent = Math.round((scrollTop / docHeight) * 100);

    armedSecurityScrollDepths.forEach(function(depth) {
        if (scrollPercent >= depth && armedScrollDepthTracked.indexOf(depth) === -1) {
            armedScrollDepthTracked.push(depth);
            gtag('event', 'scroll', {
                'event_category': 'Armed Security Engagement',
                'event_label': depth + '% Scroll',
                'value': depth,
                'service_type': '<%= serviceType %>'
            });
        }
    });
});

// Time on page tracking for armed security interest
let armedSecurityStartTime = new Date().getTime();
let armedTimeThresholds = [30, 60, 120, 300]; // seconds
let armedTimeTracked = [];

setInterval(function() {
    let currentTime = new Date().getTime();
    let timeOnPage = Math.round((currentTime - armedSecurityStartTime) / 1000);
    
    armedTimeThresholds.forEach(function(threshold) {
        if (timeOnPage >= threshold && armedTimeTracked.indexOf(threshold) === -1) {
            armedTimeTracked.push(threshold);
            gtag('event', 'timing_complete', {
                'name': 'armed_security_time_on_page',
                'value': threshold,
                'event_category': 'Armed Security Engagement',
                'service_type': '<%= serviceType %>'
            });
        }
    });
}, 10000);
</script>