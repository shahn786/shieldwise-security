<%
// Extract tracking data
const serviceType = (typeof locals !== 'undefined' && locals.serviceType) ? locals.serviceType : 'security';
const priceRange = (typeof locals !== 'undefined' && locals.priceRange) ? locals.priceRange : { low: 35, mid: 55, high: 85 };
%>

<!-- Enhanced Tracking Scripts -->
<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XXXXXXXXXX', {
    'anonymize_ip': true,
    'allow_google_signals': false,
    'allow_ad_personalization_signals': false
  });
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-XXXXXXX');</script>

<!-- Hotjar Tracking Code (Fixed) -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1234567,hjsv:6}; // Replace with actual ID
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

<!-- Microsoft Clarity -->
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "XXXXXXXXX");
</script>

<!-- Privacy Protection -->
<script>
  if (typeof window.dataLayer !== 'undefined') {
    window.dataLayer.push({
      'privacy_mode': true,
      'anonymize_data': true,
      'client_confidentiality': 'maximum'
    });
  }
</script>

<!-- Facebook Pixel -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', 'XXXXXXXXXXXXXXXXX');
  fbq('track', 'PageView');
</script>

<!-- Custom Security Service Event Tracking -->
<script>
// Enhanced lead tracking functions
function trackConsultationRequest() {
  // Google Analytics 4
  gtag('event', 'generate_lead', {
    'event_category': 'Security Services',
    'event_label': '<%= serviceType %>',
    'value': 1,
    'currency': 'USD',
    'service_type': '<%= serviceType %>',
    'lead_source': 'consultation_request'
  });

  // Facebook Pixel
  fbq('track', 'Lead', {
    content_name: '<%= serviceType %> Security Consultation',
    content_category: 'Security Services',
    value: <%= priceRange.low %>,
    currency: 'USD'
  });

  // LinkedIn
  lintrk('track', { conversion_id: 12345 });

  // Microsoft Clarity
  clarity('event', 'consultation_request');

  // Hotjar
  hj('event', 'consultation_request');
}

// Enhanced phone tracking
function trackPhoneClick() {
  gtag('event', 'phone_call', {
    'event_category': 'Contact',
    'event_label': 'Header Phone',
    'value': 1,
    'service_type': '<%= serviceType %>'
  });

  fbq('track', 'Contact', {
    content_name: 'Phone Call',
    content_category': 'Contact'
  });

  clarity('event', 'phone_click');
}

// Enhanced form tracking
function trackFormSubmission(formType) {
  gtag('event', 'form_submit', {
    'event_category': 'Lead Generation',
    'event_label': formType,
    'service_type': '<%= serviceType %>',
    'value': 1,
    'form_type': formType
  });

  fbq('track', 'CompleteRegistration', {
    content_name: formType + ' Form',
    content_category': 'Forms',
    value: <%= priceRange.low %>,
    currency: 'USD'
  });

  clarity('event', 'form_submission', {
    'form_type': formType
  });

  hj('event', 'form_submission');
}

// Scroll depth tracking
let scrollDepths = [25, 50, 75, 90];
let scrollDepthTracked = [];

window.addEventListener('scroll', function() {
  let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  let docHeight = document.documentElement.scrollHeight - window.innerHeight;
  let scrollPercent = Math.round((scrollTop / docHeight) * 100);

  scrollDepths.forEach(function(depth) {
    if (scrollPercent >= depth && scrollDepthTracked.indexOf(depth) === -1) {
      scrollDepthTracked.push(depth);
      gtag('event', 'scroll', {
        'event_category': 'Engagement',
        'event_label': depth + '%',
        'value': depth
      });
    }
  });
});

// Time on page tracking
let startTime = new Date().getTime();
let timeThresholds = [30, 60, 120, 300]; // seconds
let timeTracked = [];

setInterval(function() {
  let currentTime = new Date().getTime();
  let timeOnPage = Math.round((currentTime - startTime) / 1000);

  timeThresholds.forEach(function(threshold) {
    if (timeOnPage >= threshold && timeTracked.indexOf(threshold) === -1) {
      timeTracked.push(threshold);
      gtag('event', 'timing_complete', {
        'name': 'time_on_page',
        'value': threshold,
        'event_category': 'Engagement'
      });
    }
  });
}, 10000);

// Button click tracking
document.addEventListener('DOMContentLoaded', function() {
  // Track all CTA button clicks
  document.querySelectorAll('.btn, .cta-button, [data-track="button"]').forEach(function(button) {
    button.addEventListener('click', function() {
      let buttonText = this.textContent.trim() || this.getAttribute('aria-label') || 'Unknown Button';
      gtag('event', 'click', {
        'event_category': 'Button',
        'event_label': buttonText,
        'service_type': '<%= serviceType %>'
      });

      clarity('event', 'button_click', {
        'button_text': buttonText
      });
    });
  });

  // Track external link clicks
  document.querySelectorAll('a[href^="http"]:not([href*="shieldwisesecurity.com"])').forEach(function(link) {
    link.addEventListener('click', function() {
      gtag('event', 'click', {
        'event_category': 'External Link',
        'event_label': this.href,
        'transport_type': 'beacon'
      });
    });
  });
});

// Enhanced error tracking
window.addEventListener('error', function(e) {
  gtag('event', 'exception', {
    'description': e.message,
    'fatal': false,
    'page_url': window.location.href
  });
});

// Performance tracking
window.addEventListener('load', function() {
  setTimeout(function() {
    if ('performance' in window) {
      let perfData = performance.timing;
      let loadTime = perfData.loadEventEnd - perfData.navigationStart;

      gtag('event', 'timing_complete', {
        'name': 'page_load_time',
        'value': Math.round(loadTime),
        'event_category': 'Performance'
      });

      // Track Core Web Vitals
      if ('PerformanceObserver' in window) {
        // LCP tracking
        new PerformanceObserver((entryList) => {
          for (const entry of entryList.getEntries()) {
            gtag('event', 'web_vitals', {
              'metric_name': 'LCP',
              'metric_value': Math.round(entry.startTime),
              'metric_rating': entry.startTime < 2500 ? 'good' : entry.startTime < 4000 ? 'needs-improvement' : 'poor'
            });
          }
        }).observe({entryTypes: ['largest-contentful-paint']});
      }
    }
  }, 0);
});
</script>