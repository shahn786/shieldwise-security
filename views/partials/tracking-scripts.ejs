<%
// Extract tracking data
const serviceType = (typeof locals !== 'undefined' && locals.serviceType) ? locals.serviceType : 'security';
const priceRange = (typeof locals !== 'undefined' && locals.priceRange) ? locals.priceRange : { low: 35, mid: 55, high: 85 };
%>

<!-- Google Tag Manager -->
<script defer>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-SHLD2025');</script>

<!-- Enhanced Google Analytics 4 with Advanced E-commerce Tracking -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SHLD9876543"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Enhanced Consent Mode v2 for 2025 compliance
gtag('consent', 'default', {
  'analytics_storage': 'denied',
  'ad_storage': 'denied',
  'ad_user_data': 'denied',
  'ad_personalization': 'denied',
  'functionality_storage': 'granted',
  'security_storage': 'granted'
});

gtag('js', new Date());
gtag('config', 'G-SHLD9876543', { 
  'anonymize_ip': true,
  'allow_google_signals': false,
  'allow_ad_personalization_signals': false,
  'cookie_flags': 'SameSite=None;Secure',
  'custom_map': {
    'custom_parameter_1': 'service_type',
    'custom_parameter_2': 'price_range',
    'custom_parameter_3': 'location_served',
    'custom_parameter_4': 'lead_source'
  },
  'user_properties': {
    'service_interest': '<%= serviceType %>',
    'visitor_type': 'prospect'
  }
});

// Enhanced eCommerce tracking for security services
gtag('event', 'page_view', {
  'service_type': '<%= serviceType %>',
  'price_range': '<%= priceRange.low %>',
  'location': 'California',
  'page_category': 'service_page',
  'content_group1': 'Security Services',
  'content_group2': '<%= serviceType.charAt(0).toUpperCase() + serviceType.slice(1) %> Security'
});

// Service view tracking
gtag('event', 'view_item', {
  'currency': 'USD',
  'value': <%= priceRange.low %>,
  'items': [{
    'item_id': '<%= serviceType %>_security_service',
    'item_name': '<%= serviceType.charAt(0).toUpperCase() + serviceType.slice(1) %> Security Service',
    'item_category': 'Security Services',
    'item_brand': 'ShieldWise Security',
    'price': <%= priceRange.low %>,
    'quantity': 1
  }]
});
</script>

<!-- Microsoft Clarity with Enhanced Configuration -->
<script type="text/javascript">
(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "shld8k2m9n");

// Enhanced Clarity tracking
clarity('set', 'service_type', '<%= serviceType %>');
clarity('set', 'page_type', 'service');
clarity('set', 'price_range', '<%= priceRange.low %>-<%= priceRange.high %>');
</script>

<!-- Facebook Pixel with Enhanced Conversions -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '987654321098765', {
  'external_id': 'security_visitor'
});
fbq('track', 'PageView');

// Enhanced Facebook tracking for security services
fbq('track', 'ViewContent', {
  content_type: 'security_service',
  content_name: '<%= serviceType %>_security_service',
  content_category: 'Security Services',
  value: <%= priceRange.low %>,
  currency: 'USD',
  contents: [{
    'id': '<%= serviceType %>_security',
    'quantity': 1,
    'item_price': <%= priceRange.low %>
  }]
});
</script>

<!-- LinkedIn Insight Tag with Enhanced B2B Tracking -->
<script type="text/javascript">
_linkedin_partner_id = "5432109";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);

// Enhanced LinkedIn tracking
window._linkedin_custom_data = {
  'service_type': '<%= serviceType %>',
  'industry': 'security_services',
  'price_range': '<%= priceRange.low %>-<%= priceRange.high %>'
};
</script>
<script type="text/javascript">
(function(l) {
if (!l){window.lintrk = function(a,b){window.lintrk.q.push([a,b])};
window.lintrk.q=[]}
var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})(window.lintrk);
</script>



<!-- Custom Security Service Event Tracking -->
<script>
// Enhanced lead tracking functions
function trackConsultationRequest() {
  // Google Analytics 4
  gtag('event', 'generate_lead', {
    'event_category': 'Security Services',
    'event_label': '<%= serviceType %>',
    'value': 1,
    'currency': 'USD',
    'service_type': '<%= serviceType %>',
    'lead_source': 'consultation_request'
  });

  // Facebook Pixel
  fbq('track', 'Lead', {
    content_name: '<%= serviceType %> Security Consultation',
    content_category: 'Security Services',
    value: <%= priceRange.low %>,
    currency: 'USD'
  });

  // LinkedIn
  lintrk('track', { conversion_id: 12345 });

  // Microsoft Clarity
  clarity('event', 'consultation_request');

  
}

// Enhanced phone tracking
function trackPhoneClick() {
  gtag('event', 'phone_call', {
    'event_category': 'Contact',
    'event_label': 'Header Phone',
    'value': 1,
    'service_type': '<%= serviceType %>'
  });

  fbq('track', 'Contact', {
    content_name: 'Phone Call',
    content_category': 'Contact'
  });

  clarity('event', 'phone_click');
}

// Enhanced form tracking
function trackFormSubmission(formType) {
  gtag('event', 'form_submit', {
    'event_category': 'Lead Generation',
    'event_label': formType,
    'service_type': '<%= serviceType %>',
    'value': 1,
    'form_type': formType
  });

  fbq('track', 'CompleteRegistration', {
    content_name: formType + ' Form',
    content_category: 'Forms',
    value: <%= priceRange.low %>,
    currency: 'USD'
  });

  clarity('event', 'form_submission', {
    'form_type': formType
  });

  
}

// Scroll depth tracking
let scrollDepths = [25, 50, 75, 90];
let scrollDepthTracked = [];

window.addEventListener('scroll', function() {
  let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  let docHeight = document.documentElement.scrollHeight - window.innerHeight;
  let scrollPercent = Math.round((scrollTop / docHeight) * 100);

  scrollDepths.forEach(function(depth) {
    if (scrollPercent >= depth && scrollDepthTracked.indexOf(depth) === -1) {
      scrollDepthTracked.push(depth);
      gtag('event', 'scroll', {
        'event_category': 'Engagement',
        'event_label': depth + '%',
        'value': depth
      });
    }
  });
});

// Time on page tracking
let startTime = new Date().getTime();
let timeThresholds = [30, 60, 120, 300]; // seconds
let timeTracked = [];

setInterval(function() {
  let currentTime = new Date().getTime();
  let timeOnPage = Math.round((currentTime - startTime) / 1000);

  timeThresholds.forEach(function(threshold) {
    if (timeOnPage >= threshold && timeTracked.indexOf(threshold) === -1) {
      timeTracked.push(threshold);
      gtag('event', 'timing_complete', {
        'name': 'time_on_page',
        'value': threshold,
        'event_category': 'Engagement'
      });
    }
  });
}, 10000);

// Button click tracking
document.addEventListener('DOMContentLoaded', function() {
  // Track all CTA button clicks
  document.querySelectorAll('.btn, .cta-button, [data-track="button"]').forEach(function(button) {
    button.addEventListener('click', function() {
      let buttonText = this.textContent.trim() || this.getAttribute('aria-label') || 'Unknown Button';
      gtag('event', 'click', {
        'event_category': 'Button',
        'event_label': buttonText,
        'service_type': '<%= serviceType %>'
      });

      clarity('event', 'button_click', {
        'button_text': buttonText
      });
    });
  });

  // Track external link clicks
  document.querySelectorAll('a[href^="http"]:not([href*="shieldwisesecurity.com"])').forEach(function(link) {
    link.addEventListener('click', function() {
      gtag('event', 'click', {
        'event_category': 'External Link',
        'event_label': this.href,
        'transport_type': 'beacon'
      });
    });
  });
});

// Enhanced error tracking
window.addEventListener('error', function(e) {
  gtag('event', 'exception', {
    'description': e.message,
    'fatal': false,
    'page_url': window.location.href
  });
});

// Performance tracking
window.addEventListener('load', function() {
  setTimeout(function() {
    if ('performance' in window) {
      let perfData = performance.timing;
      let loadTime = perfData.loadEventEnd - perfData.navigationStart;

      gtag('event', 'timing_complete', {
        'name': 'page_load_time',
        'value': Math.round(loadTime),
        'event_category': 'Performance'
      });

      // Track Core Web Vitals
      if ('PerformanceObserver' in window) {
        // LCP tracking
        new PerformanceObserver((entryList) => {
          for (const entry of entryList.getEntries()) {
            gtag('event', 'web_vitals', {
              'metric_name': 'LCP',
              'metric_value': Math.round(entry.startTime),
              'metric_rating': entry.startTime < 2500 ? 'good' : entry.startTime < 4000 ? 'needs-improvement' : 'poor'
            });
          }
        }).observe({entryTypes: ['largest-contentful-paint']});
      }
    }
  }, 0);
});
</script>