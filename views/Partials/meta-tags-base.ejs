<%
  //
  // meta-tags-base.ejs
  //
  // This file defines the shared helper functions and the "safeServiceData" fallback object.
  // Both must be available before any service-specific meta tags are generated.
  //

  // First, pull in any "serviceData" that was passed down from the route:
  //   res.render('services/apartment-security', { serviceData });
  //
  // If "serviceData" is missing or some fields are undefined, we fall back to defaults.
  //

  // Destructure serviceData if it exists; otherwise use empty object
  const {
    serviceTitle,
    serviceDescription,
    serviceKeywords,
    serviceImage,
    serviceUrl,
    serviceType,
    serviceBenefit,
    propertyType,
    priceRange,
    serviceAltName,
    serviceOutput,
    audienceType
  } = typeof locals.serviceData !== 'undefined' ? serviceData : {};

  // Now build a "safeServiceData" object, filling in defaults if any property is missing:
  const safeServiceData = {
    serviceTitle:       serviceTitle       || 'Professional Security Services',
    serviceDescription: serviceDescription || 'Professional security services with licensed guards and 24/7 monitoring.',
    serviceKeywords:    serviceKeywords    || 'security services, security guards',
    serviceImage:       serviceImage       || 'default-security-service.webp',
    serviceUrl:         serviceUrl         || 'security-services',
    serviceType:        serviceType        || 'security',
    serviceBenefit:     serviceBenefit     || 'enhanced protection and peace of mind',
    propertyType:       propertyType       || 'property',
    priceRange:         priceRange         || { low: 35, mid: 55, high: 85 },
    serviceAltName:     serviceAltName     || 'Security Guard Services',
    serviceOutput:      serviceOutput      || 'Enhanced security and protection',
    audienceType:       audienceType       || 'Property Managers and Business Owners'
  };

  // Helper function: truncateTitle
  // Ensures <title> never exceeds about 58 characters (minus the suffix).
  function truncateTitle(title, maxLength = 58) {
    if (!title) return 'Security Services | ShieldWise';
    const suffix = ' | ShieldWise';
    const maxTitleLength = maxLength - suffix.length;
    if (title.length > maxTitleLength) {
      return title.substring(0, maxTitleLength).trim() + '...' + suffix;
    } else {
      return title + suffix;
    }
  }

  // Helper function: truncateDescription
  // Ensures <meta name="description"> never exceeds about 155 characters.
  function truncateDescription(desc, maxLength = 155) {
    if (!desc) {
      return 'Professional security services in California. BSIS licensed guards, 24/7 monitoring. Call 1-800-SHIELD-1 for free assessment.';
    }
    if (desc.length > maxLength) {
      return desc.substring(0, maxLength).trim() + '...';
    }
    return desc;
  }

  // Helper function: generateDynamicKeywords
  // Combines baseKeywords + serviceType phrases + "California security company" snippet.
  function generateDynamicKeywords(baseKeywords, serviceType, location = 'California') {
    const base = baseKeywords || '';
    const dynamic = `${serviceType} security, ${location} security company, licensed security guards, 24/7 security services`;
    return base + (base ? ', ' : '') + dynamic;
  }
%>